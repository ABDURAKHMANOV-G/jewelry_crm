{% extends 'base.html' %}

{% block title %}Создать заказ{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Создать новый заказ</h3>
            </div>
            <div class="card-body">
                <form method="POST" id="orderForm">
                    {% csrf_token %}
                    
                    <!-- ШАГ 1: Выбор типа изделия -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">1. Выберите тип изделия</label>
                        {{ form.product_type }}
                    </div>
                    
                    <!-- ШАГ 2: Тип заказа (показывается после выбора изделия) -->
                    <div id="orderTypeSection" class="mb-4" style="display: none;">
                        <label class="form-label fw-bold">2. Тип заказа</label>
                        {{ form.order_type }}
                    </div>
                    
                    <!-- ШАБЛОННЫЙ ЗАКАЗ -->
                    <div id="templateSection" style="display: none;">
                        <h5 class="mb-3">Параметры шаблонного заказа</h5>
                        
                        <div class="mb-3">
                            {{ form.template_image.label_tag }}
                            <select name="template_image" id="id_template_image" class="form-control">
                                <option value="">Выберите шаблон</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="templateRingSize" style="display: none;">
                            {{ form.ring_size.label_tag }}
                            {{ form.ring_size }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.material.label_tag }}
                            {{ form.material }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.comment.label_tag }}
                            {{ form.comment }}
                        </div>
                    </div>
                    
                    <!-- ИНДИВИДУАЛЬНЫЙ ЗАКАЗ -->
                    <div id="customSection" style="display: none;">
                        <h5 class="mb-3">Параметры индивидуального заказа</h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3" id="customRingSize">
                                {{ form.ring_size.label_tag }}
                                {{ form.ring_size }}
                            </div>
                            
                            <div class="col-md-6 mb-3" id="customThickness">
                                {{ form.thickness.label_tag }}
                                {{ form.thickness }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3" id="customWidth">
                                {{ form.width.label_tag }}
                                {{ form.width }}
                            </div>
                            
                            <div class="col-md-6 mb-3" id="customStoneSize">
                                {{ form.stone_size.label_tag }}
                                {{ form.stone_size }}
                            </div>
                        </div>
                        
                        <div class="mb-3" id="customWeight">
                            {{ form.desired_weight.label_tag }}
                            {{ form.desired_weight }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.material.label_tag }}
                            {{ form.material }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.comment.label_tag }}
                            {{ form.comment }}
                        </div>
                    </div>
                    
                    <!-- ОБЩИЕ ПОЛЯ -->
                    <div id="commonSection" style="display: none;">
                        <hr class="my-4">
                        <h5 class="mb-3">Дополнительная информация</h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.budget.label_tag }}
                                {{ form.budget }}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.required_by.label_tag }}
                                {{ form.required_by }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end mt-4" id="submitSection" style="display: none;">
                        <a href="{% url 'order_list' %}" class="btn btn-secondary">Отмена</a>
                        <button type="submit" class="btn btn-primary">Создать заказ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Шаблоны для каждого типа изделия
const templates = {
    'ring': [
        {value: 'ring_classic', text: 'Классическое кольцо'},
        {value: 'ring_solitaire', text: 'Солитер'},
        {value: 'ring_vintage', text: 'Винтажное'}
    ],
    'brooch': [
        {value: 'brooch_flower', text: 'Цветок'},
        {value: 'brooch_butterfly', text: 'Бабочка'},
        {value: 'brooch_bow', text: 'Бантик'}
    ],
    'bracelet': [
        {value: 'bracelet_chain', text: 'Цепочка'},
        {value: 'bracelet_bangle', text: 'Браслет-обруч'},
        {value: 'bracelet_charm', text: 'С подвесками'}
    ],
    'earrings': [
        {value: 'earrings_studs', text: 'Гвоздики'},
        {value: 'earrings_hoops', text: 'Кольца'},
        {value: 'earrings_drop', text: 'Висячие'}
    ]
};

// При выборе типа изделия
document.getElementById('id_product_type').addEventListener('change', function() {
    const productType = this.value;
    
    if (productType) {
        document.getElementById('orderTypeSection').style.display = 'block';
        
        // Заполняем шаблоны
        const templateSelect = document.getElementById('id_template_image');
        templateSelect.innerHTML = '<option value="">Выберите шаблон</option>';
        
        if (templates[productType]) {
            templates[productType].forEach(template => {
                const option = document.createElement('option');
                option.value = template.value;
                option.text = template.text;
                templateSelect.appendChild(option);
            });
        }
    } else {
        document.getElementById('orderTypeSection').style.display = 'none';
        hideAllSections();
    }
});

// При выборе типа заказа
document.getElementById('id_order_type').addEventListener('change', function() {
    const orderType = this.value;
    const productType = document.getElementById('id_product_type').value;
    
    hideAllSections();
    
    if (orderType === 'template') {
        document.getElementById('templateSection').style.display = 'block';
        document.getElementById('commonSection').style.display = 'block';
        document.getElementById('submitSection').style.display = 'block';
        
        // Показываем размер только для колец
        if (productType === 'ring') {
            document.getElementById('templateRingSize').style.display = 'block';
        }
    } else if (orderType === 'custom') {
        document.getElementById('customSection').style.display = 'block';
        document.getElementById('commonSection').style.display = 'block';
        document.getElementById('submitSection').style.display = 'block';
        
        // Настраиваем поля в зависимости от типа изделия
        configureCustomFields(productType);
    }
});

function hideAllSections() {
    document.getElementById('templateSection').style.display = 'none';
    document.getElementById('customSection').style.display = 'none';
    document.getElementById('commonSection').style.display = 'none';
    document.getElementById('submitSection').style.display = 'none';
}

function configureCustomFields(productType) {
    // По умолчанию показываем все поля
    const fields = ['customRingSize', 'customThickness', 'customWidth', 'customStoneSize', 'customWeight'];
    fields.forEach(field => document.getElementById(field).style.display = 'block');
    
    // Настраиваем в зависимости от типа
    if (productType === 'ring') {
        // Для кольца все поля актуальны
    } else if (productType === 'brooch') {
        // Для броши не нужен размер
        document.getElementById('customRingSize').style.display = 'none';
    } else if (productType === 'bracelet') {
        // Для браслета показываем длину вместо размера
        document.getElementById('customRingSize').querySelector('label').textContent = 'Длина (см)';
    } else if (productType === 'earrings') {
        // Для серёжек не нужны некоторые параметры
        document.getElementById('customRingSize').style.display = 'none';
        document.getElementById('customWidth').style.display = 'none';
    }
}
</script>
{% endblock %}
