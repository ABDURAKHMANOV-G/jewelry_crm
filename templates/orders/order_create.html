{% extends 'base.html' %}
{% load static %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ - JEWEllUX{% endblock %}

{% block content %}
<section class="create-order-section">
    <div class="container-create">
        
        <!-- HEADER -->
        <div class="create-header">
            <a href="{% url 'order_list' %}" class="btn-back">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º
            </a>
            <h1 class="create-title">
                <i class="bi bi-plus-circle"></i>
                –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
            </h1>
        </div>

        <!-- –§–û–†–ú–ê (–±–µ–∑ –∏–Ω—Ñ–æ–±–æ–∫—Å–∞ —Å–ø—Ä–∞–≤–∞) -->
        <div class="create-form">
            <form method="POST" enctype="multipart/form-data" id="orderForm">
                {% csrf_token %}
                
                <!-- –°–ï–ö–¶–ò–Ø 1: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="form-section">
                    <h2 class="form-section-title">
                        <i class="bi bi-info-circle"></i>
                        –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                    </h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_product_type">–¢–∏–ø –∏–∑–¥–µ–ª–∏—è *</label>
                            {{ form.product_type }}
                            {% if form.product_type.errors %}
                            <span class="form-error">{{ form.product_type.errors|first }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_order_type">–¢–∏–ø –∑–∞–∫–∞–∑–∞ *</label>
                            <select id="id_order_type" name="order_type" class="form-control" onchange="toggleOrderType()">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–∫–∞–∑–∞</option>
                                <option value="template">üìã –®–∞–±–ª–æ–Ω–Ω—ã–π</option>
                                <option value="custom">‚úèÔ∏è –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</option>
                            </select>
                            {% if form.order_type.errors %}
                            <span class="form-error">{{ form.order_type.errors|first }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- –°–ï–ö–¶–ò–Ø 2: –®–ê–ë–õ–û–ù–ù–´–ô –ó–ê–ö–ê–ó -->
                <div id="templateSection" class="form-section" style="display: none;">
                    <h2 class="form-section-title">
                        <i class="bi bi-bookmark"></i>
                        –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω
                    </h2>
                    
                    <!-- –ö–ê–†–£–°–ï–õ–¨ –®–ê–ë–õ–û–ù–û–í -->
                    <div class="template-carousel-wrapper">
                        <p class="carousel-hint">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è –¥–∏–∑–∞–π–Ω</p>
                        
                        <div class="template-carousel-container">
                            <button class="carousel-btn-template prev" id="prevBtnTemplate" type="button">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            
                            <div class="carousel-track-container-template">
                                <!-- –ö–ê–†–£–°–ï–õ–¨ –î–õ–Ø –ö–û–õ–ï–¶ -->
                                <div class="carousel-track-template" id="carouselRings" data-type="ring" style="display: none;">
                                    <div class="carousel-slide-template" data-template="ring1">
                                        <img src="{% static 'images/example1.png' %}" alt="–ö–æ–ª—å—Ü–æ 1">
                                        <div class="template-overlay">
                                            <span class="template-name">–ö–ª–∞—Å—Å–∏–∫–∞</span>
                                        </div>
                                    </div>
                                    <div class="carousel-slide-template" data-template="ring2">
                                        <img src="{% static 'images/example3.png' %}" alt="–ö–æ–ª—å—Ü–æ 2">
                                        <div class="template-overlay">
                                            <span class="template-name">–í–∏–Ω—Ç–∞–∂</span>
                                        </div>
                                    </div>
                                    <div class="carousel-slide-template" data-template="ring3">
                                        <img src="{% static 'images/example4.png' %}" alt="–ö–æ–ª—å—Ü–æ 3">
                                        <div class="template-overlay">
                                            <span class="template-name">–†–æ–º–∞–Ω—Ç–∏–∫</span>
                                        </div>
                                    </div>
                                    <div class="carousel-slide-template" data-template="ring1">
                                        <img src="{% static 'images/example2.png' %}" alt="–ö–æ–ª—å—Ü–æ 1">
                                        <div class="template-overlay">
                                            <span class="template-name">–ö–ª–∞—Å—Å–∏–∫–∞</span>
                                        </div>
                                    </div>
                                    <div class="carousel-slide-template" data-template="ring1">
                                        <img src="{% static 'images/example5.png' %}" alt="–ö–æ–ª—å—Ü–æ 1">
                                        <div class="template-overlay">
                                            <span class="template-name">–ö–ª–∞—Å—Å–∏–∫–∞</span>
                                        </div>
                                    </div>
                                    <div class="carousel-slide-template" data-template="ring1">
                                        <img src="{% static 'images/example_trans1.png' %}" alt="–ö–æ–ª—å—Ü–æ 1">
                                        <div class="template-overlay">
                                            <span class="template-name">–ö–ª–∞—Å—Å–∏–∫–∞</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –ö–ê–†–£–°–ï–õ–¨ –î–õ–Ø –ë–†–û–®–ï–ô -->
                                <div class="carousel-track-template" id="carouselBrooches" data-type="brooch" style="display: none;">
                                    <div class="carousel-slide-template" data-template="brooch1">
                                        <img src="{% static 'images/example_trans1.png' %}" alt="–ë—Ä–æ—à—å 1">
                                        <div class="template-overlay">
                                            <span class="template-name">–¶–≤–µ—Ç–æ–∫</span>
                                        </div>
                                    </div>
                                    <div class="carousel-slide-template" data-template="brooch2">
                                        <img src="{% static 'images/example2.png' %}" alt="–ë—Ä–æ—à—å 2">
                                        <div class="template-overlay">
                                            <span class="template-name">–ë–∞–±–æ—á–∫–∞</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –ö–ê–†–£–°–ï–õ–¨ –î–õ–Ø –ë–†–ê–°–õ–ï–¢–û–í -->
                                <div class="carousel-track-template" id="carouselBracelets" data-type="bracelet" style="display: none;">
                                    <div class="carousel-slide-template" data-template="bracelet1">
                                        <img src="{% static 'images/example2.png' %}" alt="–ë—Ä–∞—Å–ª–µ—Ç 1">
                                        <div class="template-overlay">
                                            <span class="template-name">–≠–ª–µ–≥–∞–Ω—Ç</span>
                                        </div>
                                    </div>
                                    <div class="carousel-slide-template" data-template="bracelet2">
                                        <img src="{% static 'images/example5.png' %}" alt="–ë—Ä–∞—Å–ª–µ—Ç 2">
                                        <div class="template-overlay">
                                            <span class="template-name">–ú–æ–¥–µ—Ä–Ω</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –ö–ê–†–£–°–ï–õ–¨ –î–õ–Ø –°–ï–†–Å–ì -->
                                <div class="carousel-track-template" id="carouselEarrings" data-type="earrings" style="display: none;">
                                    <div class="carousel-slide-template" data-template="earring1">
                                        <img src="{% static 'images/example5.png' %}" alt="–°–µ—Ä—å–≥–∏ 1">
                                        <div class="template-overlay">
                                            <span class="template-name">–ö–∞–ø–ª–∏</span>
                                        </div>
                                    </div>
                                    <div class="carousel-slide-template" data-template="earring2">
                                        <img src="{% static 'images/example_trans1.png' %}" alt="–°–µ—Ä—å–≥–∏ 2">
                                        <div class="template-overlay">
                                            <span class="template-name">–ü—Ä–µ–º–∏—É–º</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="carousel-btn-template next" id="nextBtnTemplate" type="button">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ -->
                        <input type="hidden" id="id_template_image" name="template_image" value="">
                        <div class="selected-template-info" id="selectedTemplateInfo" style="display: none;">
                            <i class="bi bi-check-circle-fill"></i>
                            <span>–í—ã–±—Ä–∞–Ω —à–∞–±–ª–æ–Ω: <strong id="selectedTemplateName"></strong></span>
                        </div>
                    </div>
                    
                    <!-- –†–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–ª–µ—Ü) - –ü–û–î –ö–ê–†–£–°–ï–õ–¨–Æ -->
                    <div class="form-group" id="templateRingSizeGroup" style="display: none; margin-top: 24px;">
                        <label for="id_ring_size">–†–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞ *</label>
                        {{ form.ring_size }}
                        <small class="form-hint">–£–∫–∞–∂–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –¥–ª—è —Ç–æ—á–Ω–æ–π –ø–æ—Å–∞–¥–∫–∏</small>
                    </div>
                </div>

                <!-- –¥–∞–ª—å—à–µ –∏–¥—É—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ -->

                <!-- –°–ï–ö–¶–ò–Ø 3: –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ô –ó–ê–ö–ê–ó -->
                <div id="customSection" class="form-section" style="display: none;">
                    <h2 class="form-section-title">
                        <i class="bi bi-sliders"></i>
                        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–¥–µ–ª–∏—è
                    </h2>
                    
                    <div class="form-row form-row-4">
                        <div class="form-group">
                            <label for="id_custom_size">–†–∞–∑–º–µ—Ä *</label>
                            <input type="text" id="id_custom_size" name="ring_size" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 17">
                        </div>
                        
                        <div class="form-group">
                            <label for="id_thickness">–¢–æ–ª—â–∏–Ω–∞ (–º–º) *</label>
                            {{ form.thickness }}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_width">–®–∏—Ä–∏–Ω–∞ (–º–º) *</label>
                            {{ form.width }}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_stone_size">–†–∞–∑–º–µ—Ä –∫–∞–º–Ω—è (–∫–∞—Ä–∞—Ç) *</label>
                            {{ form.stone_size }}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_desired_weight">–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å (–≥) *</label>
                        {{ form.desired_weight }}
                    </div>
                </div>

                <!-- –°–ï–ö–¶–ò–Ø 4: –ú–ê–¢–ï–†–ò–ê–õ –ò –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô -->
                <div class="form-section">
                    <h2 class="form-section-title">
                        <i class="bi bi-palette"></i>
                        –ú–∞—Ç–µ—Ä–∏–∞–ª –∏ –¥–µ—Ç–∞–ª–∏
                    </h2>
                    
                    <div class="form-group">
                        <label for="id_material">–ú–∞—Ç–µ—Ä–∏–∞–ª *</label>
                        {{ form.material }}
                        {% if form.material.errors %}
                        <span class="form-error">{{ form.material.errors|first }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
                        {{ form.comment }}
                        <small class="form-hint">–û–ø–∏—à–∏—Ç–µ –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–∑–¥–µ–ª–∏—é</small>
                    </div>
                </div>

                <!-- –°–ï–ö–¶–ò–Ø 5: –§–ò–ù–ê–ù–°–´ –ò –°–†–û–ö–ò -->
                <div class="form-section">
                    <h2 class="form-section-title">
                        <i class="bi bi-calendar3-event"></i>
                        –§–∏–Ω–∞–Ω—Å—ã –∏ —Å—Ä–æ–∫–∏
                    </h2>
                    
                    <div class="form-group">
                        <label for="proposed_price" class="form-label">
                            <i class="bi bi-calculator"></i>
                            –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç)
                        </label>
                        <div class="proposed-price-container" id="proposed_price">
                            <span class="proposed-price-value" id="proposed_price_value">0 ‚ÇΩ</span>
                            <small class="form-hint">
                                –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, —Ç–∏–ø–∞ –∏–∑–¥–µ–ª–∏—è –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_budget">–ë—é–¥–∂–µ—Ç (‚ÇΩ) *</label>
                            {{ form.budget }}
                            {% if form.budget.errors %}
                            <span class="form-error">{{ form.budget.errors|first }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_required_by">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ *</label>
                            {{ form.required_by }}
                            {% if form.required_by.errors %}
                            <span class="form-error">{{ form.required_by.errors|first }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
                <div class="form-actions">
                    <a href="{% url 'order_list' %}" class="btn-cancel">
                        <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                    </a>
                    <button type="submit" class="btn-gold btn-submit">
                        <i class="bi bi-check-circle"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </div>
            </form>
        </div>

    </div>
</section>

<script>

    // ========================================
// PRICING CONFIG - –í–°–¢–†–û–ò–¢–¨ –í –ù–ê–ß–ê–õ–û
// ========================================
const PRICING_CONFIG = {
    materials: {
        'gold_585': { name: '–ó–æ–ª–æ—Ç–æ 585', pricePerGram: 3500, density: 15.8 },
        'gold_750': { name: '–ó–æ–ª–æ—Ç–æ 750', pricePerGram: 4200, density: 17.3 },
        'silver_925': { name: '–°–µ—Ä–µ–±—Ä–æ 925', pricePerGram: 45, density: 10.5 },
        'platinum': { name: '–ü–ª–∞—Ç–∏–Ω–∞', pricePerGram: 8500, density: 21.45 }
    },
    templateCoefficients: {
        'ring': {
            'ring1': { name: '–ö–ª–∞—Å—Å–∏–∫–∞', coefficient: 1.5 },
            'ring2': { name: '–í–∏–Ω—Ç–∞–∂', coefficient: 1.8 },
            'ring3': { name: '–†–æ–º–∞–Ω—Ç–∏–∫', coefficient: 1.6 }
        },
        'brooch': {
            'brooch1': { name: '–¶–≤–µ—Ç–æ–∫', coefficient: 2.2 },
            'brooch2': { name: '–ë–∞–±–æ—á–∫–∞', coefficient: 2.0 }
        },
        'bracelet': {
            'bracelet1': { name: '–≠–ª–µ–≥–∞–Ω—Ç', coefficient: 1.9 },
            'bracelet2': { name: '–ú–æ–¥–µ—Ä–Ω', coefficient: 2.1 }
        },
        'earrings': {
            'earring1': { name: '–ö–∞–ø–ª–∏', coefficient: 1.4 },
            'earring2': { name: '–ü—Ä–µ–º–∏—É–º', coefficient: 1.7 }
        }
    },
    productComplexity: {
        'ring': 1.0,
        'brooch': 1.3,
        'bracelet': 1.1,
        'earrings': 0.9
    },
    laborCost: 0.35
};

function getMaterialPrice(materialType) {
    return PRICING_CONFIG.materials[materialType]?.pricePerGram || 0;
}

function getTemplateCoefficient(productType, templateId) {
    return PRICING_CONFIG.templateCoefficients[productType]?.[templateId]?.coefficient || 1.0;
}

function getComplexityCoefficient(productType) {
    return PRICING_CONFIG.productComplexity[productType] || 1.0;
}

function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(price);
}

function calculateTemplatePrice(weight, materialType, templateId, productType) {
    if (!weight || weight <= 0) return 0;
    const coefficient = getTemplateCoefficient(productType, templateId);
    const materialPrice = getMaterialPrice(materialType);
    const complexityCoeff = getComplexityCoefficient(productType);
    const baseMaterialCost = weight * materialPrice;
    const materialWithCoeff = baseMaterialCost * coefficient * complexityCoeff;
    const totalCost = materialWithCoeff * (1 + PRICING_CONFIG.laborCost);
    return Math.round(totalCost * 100) / 100;
}

function calculateCustomPrice(weight, materialType, productType) {
    if (!weight || weight <= 0) return 0;
    const materialPrice = getMaterialPrice(materialType);
    const complexityCoeff = getComplexityCoefficient(productType);
    const baseMaterialCost = weight * materialPrice * complexityCoeff;
    const totalCost = baseMaterialCost * (1 + PRICING_CONFIG.laborCost);
    return Math.round(totalCost * 100) / 100;
}

function updateProposedPrice() {
    const orderType = document.getElementById('id_order_type').value;
    const material = document.getElementById('id_material').value;
    let proposedPrice = 0;
    
    if (orderType === 'template') {
        const templateId = document.getElementById('id_template_image').value;
        const productType = document.getElementById('id_product_type').value;
        const ringSize = document.getElementById('id_ring_size')?.value;
        
        let weight = 3;
        if (productType === 'ring' && ringSize) {
            weight = Math.max(2, ringSize * 0.4);
        } else if (productType === 'brooch') {
            weight = 8;
        } else if (productType === 'bracelet') {
            weight = 12;
        } else if (productType === 'earrings') {
            weight = 2;
        }
        
        proposedPrice = calculateTemplatePrice(weight, material, templateId, productType);
    } else if (orderType === 'custom') {
        const productType = document.getElementById('id_product_type').value;
        const desiredWeight = parseFloat(document.getElementById('id_desired_weight')?.value) || 0;
        proposedPrice = calculateCustomPrice(desiredWeight, material, productType);
    }
    
    const priceField = document.getElementById('proposed_price_value');
    if (priceField) {
        priceField.textContent = formatPrice(proposedPrice);
        priceField.dataset.value = proposedPrice;
    }
}
// ========================================
// TOGGLE ORDER TYPE (Template/Custom)
// ========================================
function toggleOrderType() {
    const orderType = document.getElementById('id_order_type').value;
    const templateSection = document.getElementById('templateSection');
    const customSection = document.getElementById('customSection');
    const productType = document.getElementById('id_product_type').value;
    const templateRingSizeGroup = document.getElementById('templateRingSizeGroup');
    
    if (templateSection) templateSection.style.display = 'none';
    if (customSection) customSection.style.display = 'none';
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—è
    const templateRingSize = document.getElementById('id_ring_size');
    const customRingSize = document.getElementById('id_custom_size');

    if (orderType === 'template') {
        if (templateSection) templateSection.style.display = 'block';
        initTemplateCarousel();
        
         // ‚úÖ –í–ö–õ–Æ–ß–ê–ï–ú –ø–æ–ª–µ —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        if (templateRingSize) {
            templateRingSize.disabled = false;
        }
        // ‚ùå –û–¢–ö–õ–Æ–ß–ê–ï–ú –ø–æ–ª–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        if (customRingSize) {
            customRingSize.disabled = true;
            customRingSize.value = ''; // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        }

        if (productType === 'ring' && templateRingSizeGroup) {
            templateRingSizeGroup.style.display = 'block';
        } else if (templateRingSizeGroup) {
            templateRingSizeGroup.style.display = 'none';
        }
    } else if (orderType === 'custom') {
        if (customSection) customSection.style.display = 'block';
         // ‚ùå –û–¢–ö–õ–Æ–ß–ê–ï–ú –ø–æ–ª–µ —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        if (templateRingSize) {
            templateRingSize.disabled = true;
            templateRingSize.value = ''; // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        }
        // ‚úÖ –í–ö–õ–Æ–ß–ê–ï–ú –ø–æ–ª–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        if (customRingSize) {
            customRingSize.disabled = false;
        }
    } else {
        // –ï—Å–ª–∏ —Ç–∏–ø –∑–∞–∫–∞–∑–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω, –æ—Ç–∫–ª—é—á–∞–µ–º –æ–±–∞ –ø–æ–ª—è
        if (templateRingSize) templateRingSize.disabled = true;
        if (customRingSize) customRingSize.disabled = true;
    }
}

// ========================================
// INIT TEMPLATE CAROUSEL
// ========================================
function initTemplateCarousel() {
    const productType = document.getElementById('id_product_type').value;
    
    const carouselMapping = {
        'ring': 'carouselRings',
        'brooch': 'carouselBrooches',
        'bracelet': 'carouselBracelets',
        'earrings': 'carouselEarrings'
    };
    
    const carouselId = carouselMapping[productType];
    if (!carouselId) return;
    
    document.querySelectorAll('.carousel-track-template').forEach(track => {
        track.style.display = 'none';
    });
    
    const track = document.getElementById(carouselId);
    if (!track) return;
    
    track.style.display = 'flex';
    setupInfiniteCarousel(track);
}

// ========================================
// INFINITE CAROUSEL - –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –∫–∞—Ä—É—Å–µ–ª—å
// ========================================
function setupInfiniteCarousel(track) {
    const prevBtn = document.getElementById('prevBtnTemplate');
    const nextBtn = document.getElementById('nextBtnTemplate');
    const templateInput = document.getElementById('id_template_image');
    const selectedInfo = document.getElementById('selectedTemplateInfo');
    const selectedNameSpan = document.getElementById('selectedTemplateName');
    
    if (!track || !prevBtn || !nextBtn) return;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å–ª–∞–π–¥—ã (–±–µ–∑ –∫–ª–æ–Ω–æ–≤)
    const originalSlides = Array.from(track.children).filter(s => !s.classList.contains('carousel-cloned'));
    
    if (originalSlides.length < 2) {
        console.warn('–ö–∞—Ä—É—Å–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        return;
    }
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–æ–Ω—ã
    track.querySelectorAll('.carousel-cloned').forEach(c => c.remove());
    
    // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Å–ª–∞–π–¥—ã –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ø–∏–∏ –≤ –∫–æ–Ω–µ—Ü
    originalSlides.forEach(slide => {
        const clone = slide.cloneNode(true);
        clone.classList.add('carousel-cloned');
        track.appendChild(clone);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ø–∏–∏ –≤ –Ω–∞—á–∞–ª–æ
    originalSlides.slice().reverse().forEach(slide => {
        const clone = slide.cloneNode(true);
        clone.classList.add('carousel-cloned');
        track.insertBefore(clone, track.firstChild);
    });
    
    const allSlides = Array.from(track.children);
    const slideWidth = allSlides[0].getBoundingClientRect().width + 16; // +16 –¥–ª—è gap
    const totalOriginalSlides = originalSlides.length;
    
    let currentIndex = totalOriginalSlides; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞
    let isTransitioning = false;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
    updateCarouselPosition(false);
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    const newPrevBtn = prevBtn.cloneNode(true);
    const newNextBtn = nextBtn.cloneNode(true);
    prevBtn.replaceWith(newPrevBtn);
    nextBtn.replaceWith(newNextBtn);
    
    // ========================================
    // –ù–ê–í–ò–ì–ê–¶–ò–Ø
    // ========================================
    
    // –°–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥
    newNextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (isTransitioning) return;
        moveToNext();
    });
    
    // –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–∞–π–¥
    newPrevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (isTransitioning) return;
        moveToPrev();
    });
    
    function moveToNext() {
        isTransitioning = true;
        currentIndex++;
        updateCarouselPosition(true);
        
        // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞ –∫–ª–æ–Ω–æ–≤, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º—Å—è –∫ –Ω–∞—á–∞–ª—É –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–≤
        if (currentIndex >= totalOriginalSlides * 2) {
            setTimeout(() => {
                currentIndex = totalOriginalSlides;
                updateCarouselPosition(false);
                isTransitioning = false;
            }, 500); // –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å transition duration
        } else {
            setTimeout(() => {
                isTransitioning = false;
            }, 500);
        }
    }
    
    function moveToPrev() {
        isTransitioning = true;
        currentIndex--;
        updateCarouselPosition(true);
        
        // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –Ω–∞—á–∞–ª–∞ –∫–ª–æ–Ω–æ–≤, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º—Å—è –∫ –∫–æ–Ω—Ü—É –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–≤
        if (currentIndex < totalOriginalSlides) {
            setTimeout(() => {
                currentIndex = totalOriginalSlides * 2 - 1;
                updateCarouselPosition(false);
                isTransitioning = false;
            }, 500);
        } else {
            setTimeout(() => {
                isTransitioning = false;
            }, 500);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞—Ä—É—Å–µ–ª–∏
    function updateCarouselPosition(animate) {
        const moveDistance = currentIndex * slideWidth;
        
        if (animate) {
            track.style.transition = 'transform 0.5s ease-in-out';
        } else {
            track.style.transition = 'none';
        }
        
        track.style.transform = `translateX(-${moveDistance}px)`;
    }
    
    // ========================================
    // –í–´–ë–û–† –®–ê–ë–õ–û–ù–ê
    // ========================================
    allSlides.forEach(slide => {
        slide.addEventListener('click', function() {
            allSlides.forEach(s => s.classList.remove('selected'));
            this.classList.add('selected');
            
            const templateId = this.getAttribute('data-template');
            const templateName = this.querySelector('.template-name')?.textContent;
            
            if (templateInput) {
                templateInput.value = templateId;
            }
            
            if (selectedInfo && selectedNameSpan && templateName) {
                selectedInfo.style.display = 'flex';
                selectedNameSpan.textContent = templateName;
            }
        });
    });
}

// ========================================
// FORM VALIDATION (–° –í–ê–õ–ò–î–ê–¶–ò–ï–ô –í–°–ï–• –ü–û–õ–ï–ô)
// ========================================
function validateForm() {
    let isValid = true;
    const errors = [];
    
    const productType = document.getElementById('id_product_type');
    const orderType = document.getElementById('id_order_type');
    const material = document.getElementById('id_material');
    const budget = document.getElementById('id_budget');
    const requiredBy = document.getElementById('id_required_by');
    const templateImage = document.getElementById('id_template_image');
    const ringSize = document.getElementById('id_ring_size');
    
    // –ü–æ–ª—è –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
    const thickness = document.getElementById('id_thickness');
    const width = document.getElementById('id_width');
    const stoneSize = document.getElementById('id_stone_size');
    const desiredWeight = document.getElementById('id_desired_weight');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –¢–∏–ø –∏–∑–¥–µ–ª–∏—è
    if (!productType || !productType.value) {
        showError(productType, '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–∑–¥–µ–ª–∏—è');
        errors.push('–¢–∏–ø –∏–∑–¥–µ–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
        isValid = false;
    } else {
        clearError(productType);
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –¢–∏–ø –∑–∞–∫–∞–∑–∞
    if (!orderType || !orderType.value) {
        showError(orderType, '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–∫–∞–∑–∞');
        errors.push('–¢–∏–ø –∑–∞–∫–∞–∑–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
        isValid = false;
    } else {
        clearError(orderType);
        
        // ========================================
        // –í–ê–õ–ò–î–ê–¶–ò–Ø –î–õ–Ø –®–ê–ë–õ–û–ù–ù–û–ì–û –ó–ê–ö–ê–ó–ê
        // ========================================
        if (orderType.value === 'template') {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞
            if (!templateImage || !templateImage.value) {
                errors.push('–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –∏–∑ –∫–∞—Ä—É—Å–µ–ª–∏');
                isValid = false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–ª—å—Ü–∞ –¥–ª—è –∫–æ–ª–µ—Ü
            if (productType.value === 'ring') {
                if (!ringSize || !ringSize.value) {
                    showError(ringSize, '–£–∫–∞–∂–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞');
                    errors.push('–†–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∫–æ–ª–µ—Ü');
                    isValid = false;
                } else {
                    clearError(ringSize);
                }
            }
        }
        // ========================================
        // –í–ê–õ–ò–î–ê–¶–ò–Ø –î–õ–Ø –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–û–ì–û –ó–ê–ö–ê–ó–ê
        // ========================================
        if (orderType.value === 'custom') {
            // –†–∞–∑–º–µ—Ä (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞)
            const customSize = document.getElementById('id_custom_size');
            if (!customSize || !customSize.value || customSize.value.trim() === '') {
                showError(customSize, '–£–∫–∞–∂–∏—Ç–µ —Ä–∞–∑–º–µ—Ä');
                errors.push('–†–∞–∑–º–µ—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                isValid = false;
            } else {
                clearError(customSize);
            }
            
            // –¢–æ–ª—â–∏–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º > 0)
            const thicknessValue = parseFloat(thickness?.value);
            if (!thickness || !thickness.value || thickness.value.trim() === '' || isNaN(thicknessValue) || thicknessValue <= 0) {
                showError(thickness, '–£–∫–∞–∂–∏—Ç–µ —Ç–æ–ª—â–∏–Ω—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0)');
                errors.push('–¢–æ–ª—â–∏–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
                isValid = false;
            } else {
                clearError(thickness);
            }
            
            // –®–∏—Ä–∏–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º > 0)
            const widthValue = parseFloat(width?.value);
            if (!width || !width.value || width.value.trim() === '' || isNaN(widthValue) || widthValue <= 0) {
                showError(width, '–£–∫–∞–∂–∏—Ç–µ —à–∏—Ä–∏–Ω—É (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0)');
                errors.push('–®–∏—Ä–∏–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
                isValid = false;
            } else {
                clearError(width);
            }
            
            // –†–∞–∑–º–µ—Ä –∫–∞–º–Ω—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º > 0)
            const stoneSizeValue = parseFloat(stoneSize?.value);
            if (!stoneSize || !stoneSize.value || stoneSize.value.trim() === '' || isNaN(stoneSizeValue) || stoneSizeValue <= 0) {
                showError(stoneSize, '–£–∫–∞–∂–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∫–∞–º–Ω—è (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0)');
                errors.push('–†–∞–∑–º–µ—Ä –∫–∞–º–Ω—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
                isValid = false;
            } else {
                clearError(stoneSize);
            }
            
            // –ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º > 0)
            const desiredWeightValue = parseFloat(desiredWeight?.value);
            if (!desiredWeight || !desiredWeight.value || desiredWeight.value.trim() === '' || isNaN(desiredWeightValue) || desiredWeightValue <= 0) {
                showError(desiredWeight, '–£–∫–∞–∂–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π –≤–µ—Å (—á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0)');
                errors.push('–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
                isValid = false;
            } else {
                clearError(desiredWeight);
            }
        }

    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –ú–∞—Ç–µ—Ä–∏–∞–ª
    if (!material || !material.value) {
        showError(material, '–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª');
        errors.push('–ú–∞—Ç–µ—Ä–∏–∞–ª –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
        isValid = false;
    } else {
        clearError(material);
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –ë—é–¥–∂–µ—Ç
    if (!budget || !budget.value || parseFloat(budget.value) <= 0) {
        showError(budget, '–£–∫–∞–∂–∏—Ç–µ –±—é–¥–∂–µ—Ç (–±–æ–ª—å—à–µ 0)');
        errors.push('–ë—é–¥–∂–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
        isValid = false;
    } else {
        clearError(budget);
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    if (!requiredBy || !requiredBy.value) {
        showError(requiredBy, '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏');
        errors.push('–î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞');
        isValid = false;
    } else {
        const selectedDate = new Date(requiredBy.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
            showError(requiredBy, '–î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º');
            errors.push('–î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º');
            isValid = false;
        } else {
            clearError(requiredBy);
        }
    }
    
    if (!isValid) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n\n' + errors.join('\n'));
    }
    
    return isValid;
}


function showError(field, message) {
    if (!field) return;
    field.style.borderColor = '#ff5459';
    field.style.background = 'rgba(255, 84, 89, 0.05)';
    
    const parent = field.closest('.form-group');
    if (parent) {
        const oldError = parent.querySelector('.form-error-custom');
        if (oldError) oldError.remove();
        
        const errorDiv = document.createElement('span');
        errorDiv.className = 'form-error form-error-custom';
        errorDiv.textContent = message;
        parent.appendChild(errorDiv);
    }
}

function clearError(field) {
    if (!field) return;
    field.style.borderColor = '';
    field.style.background = '';
    
    const parent = field.closest('.form-group');
    if (parent) {
        const error = parent.querySelector('.form-error-custom');
        if (error) error.remove();
    }
}

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    const productTypeSelect = document.getElementById('id_product_type');
    const orderTypeSelect = document.getElementById('id_order_type');
    const form = document.getElementById('orderForm');
    
    if (productTypeSelect) {
        productTypeSelect.addEventListener('change', toggleOrderType);
    }
    
    if (orderTypeSelect) {
        orderTypeSelect.addEventListener('change', toggleOrderType);
    }
    
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                return false;
            }
        });
    }
    
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            clearError(this);
        });
        input.addEventListener('change', function() {
            clearError(this);
        });
    });
// –î–û–ë–ê–í–ò–¢–¨ —ç—Ç–∏ –ø–æ–ª—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã
    const priceFields = [
        'id_order_type',
        'id_product_type',
        'id_material',
        'id_template_image',
        'id_ring_size',
        'id_desired_weight'
    ];
    
    priceFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', updateProposedPrice);
            field.addEventListener('input', updateProposedPrice);
        }
    });
    
    setTimeout(updateProposedPrice, 500);
});
</script>


{% endblock %}
