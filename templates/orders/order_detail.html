{% extends 'base.html' %}
{% load phone_filters %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.order_id }} - JEWEllUX{% endblock %}

{% block content %}
<section class="order-detail-section">
    {% if messages %}
    <div class="alerts" style="margin-bottom: 20px;">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}" role="alert" style="...">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}
    <div class="container-detail">

        <!-- HEADER —Å —Å—Ç–∞—Ç—É—Å–æ–º –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
        <div class="detail-header">
            <div class="detail-title-block">
                <a href="{% url 'order_list' %}" class="btn-back">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º
                </a>
                <h1 class="detail-title">
                    <i class="bi bi-file-text"></i>
                    –ó–∞–∫–∞–∑ #{{ order.order_id }}
                </h1>
                <span class="status-badge status-{{ order.order_status }}">
                    {{ order.get_status_display_ru }}
                </span>
            </div>

            <div class="detail-actions">
                <a href="{% url 'document_list' order.order_id %}" class="btn-action btn-documents">
                    <i class="bi bi-file-earmark-text"></i> –î–æ–∫—É–º–µ–Ω—Ç—ã
                </a>
                
                <!-- ‚úÖ –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¢–ó -->
                {% if user.role == 'manager' %}
                <a href="{% url 'generate_modeler_brief' order.order_id %}" 
                class="btn-action btn-brief"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="bi bi-file-earmark-arrow-down"></i> –°–æ–∑–¥–∞—Ç—å –¢–ó –¥–ª—è –º–æ–¥–µ–ª—å–µ—Ä–∞
                </a>
                {% endif %}

                {% if user.role == 'manager' or user.role == 'client' and order.order_status == 'new' %}
                <a href="{% url 'order_delete' order.order_id %}" 
                   class="btn-action btn-delete"
                   onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')">
                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </a>
                {% endif %}
            </div>
        </div>

        <!-- GRID: –õ–µ–≤–∞—è –∏ –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∏ -->
        <div class="detail-grid">

        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
        <div class="detail-card detail-card-main">
            <h2 class="card-title">
                <i class="bi bi-info-circle"></i>
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ
            </h2>

            <div class="info-group">
                <!-- –¢–∏–ø –∏–∑–¥–µ–ª–∏—è -->
                <div class="info-item">
                    <span class="info-label">–¢–∏–ø –∏–∑–¥–µ–ª–∏—è</span>
                    <span class="info-value">
                        {% if order.order_type == 'collection' %}
                            ‚≠ê –≠–∫—Å–∫–ª—é–∑–∏–≤
                        {% elif order.product_type == 'ring' %}
                            üíç –ö–æ–ª—å—Ü–æ
                        {% elif order.product_type == 'brooch' %}
                            üå∏ –ë—Ä–æ—à—å
                        {% elif order.product_type == 'bracelet' %}
                            üìø –ë—Ä–∞—Å–ª–µ—Ç
                        {% elif order.product_type == 'earring' or order.product_type == 'earrings' %}
                            üíé –°–µ—Ä—å–≥–∏
                        {% elif order.product_type == 'necklace' %}
                            üíé –ö–æ–ª—å–µ
                        {% elif order.product_type == 'pendant' %}
                            üí† –ü–æ–¥–≤–µ—Å–∫–∞
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>

                <!-- –¢–∏–ø –∑–∞–∫–∞–∑–∞ -->
                <div class="info-item">
                    <span class="info-label">–¢–∏–ø –∑–∞–∫–∞–∑–∞</span>
                    <span class="info-value">
                        {% if order.order_type == 'template' %}
                            <span class="order-type template">üìã –®–∞–±–ª–æ–Ω–Ω—ã–π</span>
                        {% elif order.order_type == 'custom' %}
                            <span class="order-type custom">‚úèÔ∏è –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</span>
                        {% elif order.order_type == 'collection' %}
                            <span class="order-type collection">üõçÔ∏è –ü—Ä–µ–¥–∑–∞–∫–∞–∑</span>
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>

                <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ -->
                {% if order.collection_product_name %}
                <div class="info-item">
                    <span class="info-label">–ò–∑–¥–µ–ª–∏–µ</span>
                    <span class="info-value" style="color: #d4af37; font-weight: 500;">
                        ‚ú® {{ order.collection_product_name }}
                    </span>
                </div>
                {% endif %}

                <!-- –ú–∞—Ç–µ—Ä–∏–∞–ª -->
                {% if order.material %}
                <div class="info-item">
                    <span class="info-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</span>
                    <span class="info-value material">
                        {% if order.material == 'gold_585' %}
                            ‚öúÔ∏è –ó–æ–ª–æ—Ç–æ 585
                        {% elif order.material == 'gold_750' %}
                            ‚öúÔ∏è –ó–æ–ª–æ—Ç–æ 750
                        {% elif order.material == 'silver_925' %}
                            üî∑ –°–µ—Ä–µ–±—Ä–æ 925
                        {% elif order.material == 'platinum' %}
                            üíé –ü–ª–∞—Ç–∏–Ω–∞
                        {% else %}
                            {{ order.material }}
                        {% endif %}
                    </span>
                </div>
                {% endif %}
                
                <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ -->
                {% if order.estimated_price %}
                <div class="info-item">
                    <span class="info-label">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞</span>
                    <span class="info-value" style="color: #d4af37; font-weight: 600;">
                        {{ order.estimated_price|floatformat:0 }} ‚ÇΩ
                    </span>
                </div>
                {% else %}
                <div class="info-item">
                    <span class="info-label">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞</span>
                    <span class="info-value" style="color: #999;">
                        –†–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                    </span>
                </div>
                {% endif %}

                <!-- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ -->
                {% if order.final_price %}
                <div class="info-item">
                    <span class="info-label">–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞</span>
                    <span class="info-value" style="color: #28a745; font-weight: 600;">
                        {{ order.final_price|floatformat:0 }} ‚ÇΩ
                        {% if order.price_confirmed %}
                        <span style="display: block; color: #28a745; font-size: 11px; margin-top: 3px;">‚úì –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</span>
                        {% endif %}
                    </span>
                </div>
                {% endif %}

                <!-- –ë—é–¥–∂–µ—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤) -->
                {% if order.budget and order.order_type != 'collection' %}
                <div class="info-item">
                    <span class="info-label">–ë—é–¥–∂–µ—Ç</span>
                    <span class="info-value budget">{{ order.budget }} ‚ÇΩ</span>
                </div>
                {% endif %}

                <!-- –î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ -->
                {% if order.required_by %}
                <div class="info-item">
                    <span class="info-label">–î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</span>
                    <span class="info-value">{{ order.required_by|date:"d.m.Y H:i" }}</span>
                </div>
                {% endif %}
            </div>
        </div>

            <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ö–ª–∏–µ–Ω—Ç -->
            <div class="detail-card">
                <h2 class="card-title">
                    <i class="bi bi-person"></i>
                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ
                </h2>

                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">–ò–º—è</span>
                        <span class="info-value">{{ order.customer.name }} {{ order.customer.surname }}</span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                        <span class="info-value">
                            <a href="tel:{{ order.customer.phone }}">{{ order.customer.phone|format_phone }}</a>
                        </span>
                    </div>

                    {% if order.customer.email %}
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">
                            <a href="mailto:{{ order.customer.email }}">{{ order.customer.email }}</a>
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- üî¥ –†–ê–ó–ú–ï–†–´ –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –¢–ò–ü–ê –ó–ê–ö–ê–ó–ê -->
        <div class="detail-card detail-params" id="parametersBlock">
            <h2 class="card-title">
                <i class="bi bi-rulers"></i>
                <span id="paramsTitle">–†–∞–∑–º–µ—Ä—ã –∏–∑–¥–µ–ª–∏—è</span>
            </h2>
            <div class="params-grid" id="paramsContent">
                <p style="color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤...</p>
            </div>
        </div>

        <!-- –®–ê–ë–õ–û–ù –¥–ª—è TEMPLATE –∑–∞–∫–∞–∑–∞ -->
        {% if order.order_type == 'template' %}
        <div class="detail-card">
            <h2 class="card-title">
                <i class="bi bi-bookmark"></i>
                –®–∞–±–ª–æ–Ω
            </h2>
            <div class="info-group">
                <div class="info-item">
                    <span class="info-label">–í—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω</span>
                    <span class="info-value">{{ order.template_image|default:"-" }}</span>
                </div>

                {% if order.product_type == 'ring' and order.ring_size %}
                <div class="info-item">
                    <span class="info-label">–†–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞</span>
                    <span class="info-value">{{ order.ring_size }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –∫–ª–∏–µ–Ω—Ç–∞ -->
        {% if order.comment %}
        <div class="detail-card detail-description">
            <h2 class="card-title">
                <i class="bi bi-chat-left-text"></i>
                –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞
            </h2>
            <p class="description-text">{{ order.comment }}</p>
        </div>
        {% endif %}

        <!-- –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨ –ò –î–ê–¢–´ -->
        <div class="detail-grid detail-meta">
            <div class="detail-card">
                <h2 class="card-title">
                    <i class="bi bi-person-workspace"></i>
                    –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                </h2>
                <div class="info-item">
                    {% if order.user %}
                        <span class="info-value">{{ order.user.get_full_name|default:order.user.username }}</span>
                    {% else %}
                        <span class="info-value muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                    {% endif %}
                </div>
            </div>

            <div class="detail-card">
                <h2 class="card-title">
                    <i class="bi bi-clock-history"></i>
                    –î–∞—Ç—ã
                </h2>
                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">–°–æ–∑–¥–∞–Ω</span>
                        <span class="info-value">{{ order.created_at|date:"d.m.Y H:i" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">–û–±–Ω–æ–≤–ª–µ–Ω</span>
                        <span class="info-value">{{ order.updated_at|date:"d.m.Y H:i" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–û–†–ú–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –î–õ–Ø –ú–ï–ù–ï–î–ñ–ï–†–ê -->
        {% if user.role == 'manager' %}
        <div class="detail-card manager-edit-card">
            <h2 class="card-title">
                <i class="bi bi-pencil-square"></i>
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–º–µ–Ω–µ–¥–∂–µ—Ä)
            </h2>

            <form method="POST" id="managerEditForm" class="manager-form">
                {% csrf_token %}

                <!-- –°—Ç–∞—Ç—É—Å –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_order_status">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</label>
                        {{ update_form.order_status }}
                    </div>

                    <div class="form-group">
                        <label for="id_user">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                        {{ update_form.user }}
                    </div>
                </div>

                <div class="form-divider"></div>

                <!-- –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ü–µ–Ω—ã (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞) -->
                <h3 class="form-section-title">
                    <i class="bi bi-currency-dollar"></i>
                    –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                </h3>

                <!-- –ë—é–¥–∂–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º) -->
                <div class="form-group">
                    <label>–ë—é–¥–∂–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (‚ÇΩ)</label>
                    <div style="padding: 12px 14px; background: rgba(255, 255, 255, 0.03); 
                                border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 8px; color: #cccccc;">
                        {{ order.budget }} ‚ÇΩ
                    </div>
                    <small class="form-hint">–ë—é–¥–∂–µ—Ç, —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç–æ–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞</small>
                </div>

                <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ (—Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º) -->
                <div class="form-group">
                    <label class="form-label">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–æ–π</label>
                    <div class="proposed-price-container" style="margin-top: 8px;">
                        <span class="proposed-price-value" id="estimated_price_display">
                            {{ order.estimated_price|default:"–†–∞—Å—Å—á–∏—Ç–∞–µ—Ç—Å—è"|floatformat:0 }} ‚ÇΩ
                        </span>
                        <small class="form-hint">
                            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞, —Ç–∏–ø–∞ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
                        </small>
                    </div>
                </div>

                <!-- –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞ (–ü–û–õ–ï –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø) -->
                <div class="form-group">
                    <label for="id_final_price" class="form-label">
                        <i class="bi bi-check-circle-fill"></i>
                        –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (‚ÇΩ) *
                    </label>
                    {{ update_form.final_price }}
                    <small class="form-hint">
                        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞.
                        <button 
                            type="button" 
                            onclick="applyEstimatedPrice(event);" 
                            style="
                                background: #d4af37;
                                color: #1a1a1a;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 14px;
                                margin-left: 10px;
                            "
                        >
                            –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—É—é ‚úì
                        </button>
                    </small>
                </div>
                <!-- –¢–∏–ø –∏–∑–¥–µ–ª–∏—è –∏ —Ç–∏–ø –∑–∞–∫–∞–∑–∞ -->
                <h3 class="form-section-title">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_product_type">–¢–∏–ø –∏–∑–¥–µ–ª–∏—è</label>
                        {{ update_form.product_type }}
                    </div>

                    <div class="form-group">
                        <label for="id_order_type_edit">–¢–∏–ø –∑–∞–∫–∞–∑–∞</label>
                        <select name="order_type" id="id_order_type_edit" class="form-control">
                            <option value="">------</option>
                            <option value="template" {% if order.order_type == 'template' %}selected{% endif %}>–®–∞–±–ª–æ–Ω–Ω—ã–π</option>
                            <option value="custom" {% if order.order_type == 'custom' %}selected{% endif %}>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</option>
                        </select>
                    </div>
                </div>

                <!-- ‚úÖ –û–ë–©–ï–ï –ü–û–õ–ï RING_SIZE (–¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤) -->
                <div class="form-group" id="ringSizeGroup" style="display: none;">
                    <label for="id_ring_size">–†–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞</label>
                    {{ update_form.ring_size }}
                    <small class="form-hint">–î–ª—è –∫–æ–ª–µ—Ü</small>
                </div>

                <!-- –®–ê–ë–õ–û–ù–ù–´–ô –ó–ê–ö–ê–ó (–ë–ï–ó ring_size) -->
                <div id="templateEditSection" style="display: none;">
                    <div class="form-divider"></div>
                    <h3 class="form-section-title">üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞</h3>

                    <div class="form-group">
                        <label for="id_template_image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
                        {{ update_form.template_image }}
                    </div>

                    <div class="form-group">
                        <label for="id_material">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        {{ update_form.material }}
                    </div>

                    <div class="form-group">
                        <label for="id_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        {{ update_form.comment }}
                    </div>
                </div>

                <!-- –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ô –ó–ê–ö–ê–ó (–ë–ï–ó ring_size) -->
                <div id="customEditSection" style="display: none;">
                    <div class="form-divider"></div>
                    <h3 class="form-section-title">‚úèÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞</h3>

                    <div class="form-row form-row-3">
                        <!-- ‚ùå –£–î–ê–õ–ò–õ–ò ring_size –æ—Ç—Å—é–¥–∞ -->
                        
                        <div class="form-group">
                            <label for="id_thickness">–¢–æ–ª—â–∏–Ω–∞ (–º–º)</label>
                            {{ update_form.thickness }}
                        </div>

                        <div class="form-group">
                            <label for="id_width">–®–∏—Ä–∏–Ω–∞ (–º–º)</label>
                            {{ update_form.width }}
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_stone_size">–†–∞–∑–º–µ—Ä –∫–∞–º–Ω—è (–∫–∞—Ä–∞—Ç)</label>
                            {{ update_form.stone_size }}
                        </div>

                        <div class="form-group">
                            <label for="id_desired_weight">–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å (–≥)</label>
                            {{ update_form.desired_weight }}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_material">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        {{ update_form.material }}
                    </div>

                    <div class="form-group">
                        <label for="id_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        {{ update_form.comment }}
                    </div>
                </div>

                <div class="form-divider"></div>

                <!-- –ë—é–¥–∂–µ—Ç –∏ —Å—Ä–æ–∫ -->
                <h3 class="form-section-title">üí∞ –§–∏–Ω–∞–Ω—Å—ã –∏ —Å—Ä–æ–∫–∏</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_budget">–ë—é–¥–∂–µ—Ç (‚ÇΩ)</label>
                        {{ update_form.budget }}
                    </div>

                    <div class="form-group">
                        <label for="id_required_by">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</label>
                        {{ update_form.required_by }}
                    </div>
                </div>

                <button type="submit" class="btn-gold btn-lg-full">
                    <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </form>
        </div>
        {% endif %}

    </div>
</section>

<script>

document.addEventListener('DOMContentLoaded', function() {
    function updateParametersBlock() {
        const orderType = '{{ order.order_type }}';
        const productType = '{{ order.product_type }}';
        const paramsContent = document.getElementById('paramsContent');
        const paramsTitle = document.getElementById('paramsTitle');
        
        let html = '';
        
        if (orderType === 'collection') {
            // üõçÔ∏è –î–õ–Ø –ó–ê–ö–ê–ó–û–í –ò–ó –ö–û–õ–õ–ï–ö–¶–ò–ò
            paramsTitle.textContent = 'üõçÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞';
            
            const productName = '{{ order.collection_product_name|default:"‚Äî" }}';
            const ringSize = '{{ order.ring_size|default:"" }}';
            const comment = '{{ order.comment|default:"" }}';
            
            if (productName !== '‚Äî') {
                html += `
                    <div class="param-item">
                        <span class="param-label">–ò–∑–¥–µ–ª–∏–µ</span>
                        <span class="param-value" style="color: #d4af37; font-weight: 500;">‚ú® ${productName}</span>
                    </div>
                `;
            }
            
            if (ringSize) {
                html += `
                    <div class="param-item">
                        <span class="param-label">–†–∞–∑–º–µ—Ä</span>
                        <span class="param-value">${ringSize}</span>
                    </div>
                `;
            } else {
                html += `
                    <div class="param-item">
                        <span class="param-label">–†–∞–∑–º–µ—Ä</span>
                        <span class="param-value" style="color: #999;">–£–∫–∞–∑–∞–Ω –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                    </div>
                `;
            }
            
            if (comment) {
                html += `
                    <div class="param-item full-width">
                        <span class="param-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞</span>
                        <span class="param-value" style="line-height: 1.6;">${comment}</span>
                    </div>
                `;
            }
            
        } else if (orderType === 'template') {
            // üìã –î–õ–Ø –®–ê–ë–õ–û–ù–ù–´–• –ó–ê–ö–ê–ó–û–í
            paramsTitle.textContent = 'üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞';
            
            const template = '{{ order.template_image|default:"‚Äî" }}';
            html += `
                <div class="param-item">
                    <span class="param-label">–®–∞–±–ª–æ–Ω</span>
                    <span class="param-value">${template}</span>
                </div>
            `;
            
            const ringSize = '{{ order.ring_size|default:"‚Äî" }}';
            html += `
                <div class="param-item">
                    <span class="param-label">–†–∞–∑–º–µ—Ä</span>
                    <span class="param-value">${ringSize}</span>
                </div>
            `;
            
        } else if (orderType === 'custom') {
            // ‚úèÔ∏è –î–õ–Ø –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–• –ó–ê–ö–ê–ó–û–í
            paramsTitle.textContent = '‚úèÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞';
            
            const ring_size = '{{ order.ring_size|default:"‚Äî" }}';
            const thickness = '{{ order.thickness|default:"‚Äî" }}';
            const width = '{{ order.width|default:"‚Äî" }}';
            const stone_size = '{{ order.stone_size|default:"‚Äî" }}';
            const desired_weight = '{{ order.desired_weight|default:"‚Äî" }}';
            
            html += `
                <div class="param-item">
                    <span class="param-label">–†–∞–∑–º–µ—Ä</span>
                    <span class="param-value">${ring_size}</span>
                </div>
                <div class="param-item">
                    <span class="param-label">–¢–æ–ª—â–∏–Ω–∞</span>
                    <span class="param-value">${thickness} ${thickness !== '‚Äî' ? '–º–º' : ''}</span>
                </div>
                <div class="param-item">
                    <span class="param-label">–®–∏—Ä–∏–Ω–∞</span>
                    <span class="param-value">${width} ${width !== '‚Äî' ? '–º–º' : ''}</span>
                </div>
                <div class="param-item">
                    <span class="param-label">–†–∞–∑–º–µ—Ä –∫–∞–º–Ω—è</span>
                    <span class="param-value">${stone_size} ${stone_size !== '‚Äî' ? '–∫–∞—Ä–∞—Ç' : ''}</span>
                </div>
                <div class="param-item">
                    <span class="param-label">–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å</span>
                    <span class="param-value">${desired_weight} ${desired_weight !== '‚Äî' ? '–≥' : ''}</span>
                </div>
            `;
        }
        
        if (html) {
            paramsContent.innerHTML = html;
        } else {
            paramsContent.innerHTML = '<p style="color: #999;">–ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</p>';
        }
    }
    
    updateParametersBlock();
});

// ========================================
// PRICING CONFIG
// ========================================
const PRICING_CONFIG = {
    materials: {
        'gold_585': { name: '–ó–æ–ª–æ—Ç–æ 585', pricePerGram: 3500, density: 15.8 },
        'gold_750': { name: '–ó–æ–ª–æ—Ç–æ 750', pricePerGram: 4200, density: 17.3 },
        'silver_925': { name: '–°–µ—Ä–µ–±—Ä–æ 925', pricePerGram: 45, density: 10.5 },
        'platinum': { name: '–ü–ª–∞—Ç–∏–Ω–∞', pricePerGram: 8500, density: 21.45 }
    },
    templateCoefficients: {
        'ring': {
            'ring1': { name: '–ö–ª–∞—Å—Å–∏–∫–∞', coefficient: 1.5 },
            'ring2': { name: '–í–∏–Ω—Ç–∞–∂', coefficient: 1.8 },
            'ring3': { name: '–†–æ–º–∞–Ω—Ç–∏–∫', coefficient: 1.6 }
        },
        'brooch': {
            'brooch1': { name: '–¶–≤–µ—Ç–æ–∫', coefficient: 2.2 },
            'brooch2': { name: '–ë–∞–±–æ—á–∫–∞', coefficient: 2.0 }
        },
        'bracelet': {
            'bracelet1': { name: '–≠–ª–µ–≥–∞–Ω—Ç', coefficient: 1.9 },
            'bracelet2': { name: '–ú–æ–¥–µ—Ä–Ω', coefficient: 2.1 }
        },
        'earrings': {
            'earring1': { name: '–ö–∞–ø–ª–∏', coefficient: 1.4 },
            'earring2': { name: '–ü—Ä–µ–º–∏—É–º', coefficient: 1.7 }
        }
    },
    productComplexity: {
        'ring': 1.0,
        'brooch': 1.3,
        'bracelet': 1.1,
        'earrings': 0.9
    },
    laborCost: 0.35
};

function getMaterialPrice(materialType) {
    return PRICING_CONFIG.materials[materialType]?.pricePerGram || 0;
}

function getTemplateCoefficient(productType, templateId) {
    return PRICING_CONFIG.templateCoefficients[productType]?.[templateId]?.coefficient || 1.0;
}

function getComplexityCoefficient(productType) {
    return PRICING_CONFIG.productComplexity[productType] || 1.0;
}

function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(price);
}

function calculateTemplatePrice(weight, materialType, templateId, productType) {
    if (!weight || weight <= 0) return 0;
    const coefficient = getTemplateCoefficient(productType, templateId);
    const materialPrice = getMaterialPrice(materialType);
    const complexityCoeff = getComplexityCoefficient(productType);
    const baseMaterialCost = weight * materialPrice;
    const materialWithCoeff = baseMaterialCost * coefficient * complexityCoeff;
    const totalCost = materialWithCoeff * (1 + PRICING_CONFIG.laborCost);
    return Math.round(totalCost * 100) / 100;
}

function calculateCustomPrice(weight, materialType, productType) {
    if (!weight || weight <= 0) return 0;
    const materialPrice = getMaterialPrice(materialType);
    const complexityCoeff = getComplexityCoefficient(productType);
    const baseMaterialCost = weight * materialPrice * complexityCoeff;
    const totalCost = baseMaterialCost * (1 + PRICING_CONFIG.laborCost);
    return Math.round(totalCost * 100) / 100;
}

document.addEventListener('DOMContentLoaded', function() {
    const orderTypeSelect = document.getElementById('id_order_type_edit');
    const productTypeSelect = document.getElementById('id_product_type');

    if (orderTypeSelect) {
        orderTypeSelect.addEventListener('change', function() {
            toggleEditSections();
            updateProposedPrice();
        });
    }

    if (productTypeSelect) {
        productTypeSelect.addEventListener('change', function() {
            const orderType = orderTypeSelect ? orderTypeSelect.value : '{{ order.order_type }}';
            const productType = this.value;

            if (orderType === 'template' && productType === 'ring') {
                document.getElementById('templateRingSizeEdit').style.display = 'block';
            } else {
                document.getElementById('templateRingSizeEdit').style.display = 'none';
            }

            updateProposedPrice();
        });
    }

    const priceFields = [
        'id_order_type_edit', 'id_product_type', 'id_material', 'id_template_image',
        'id_ring_size', 'id_thickness', 'id_width', 'id_stone_size', 'id_desired_weight'
    ];

    priceFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', updateProposedPrice);
            field.addEventListener('input', updateProposedPrice);
        }
    });

    function toggleEditSections() {
        const orderType = orderTypeSelect ? orderTypeSelect.value : '{{ order.order_type }}';
        const productType = productTypeSelect ? productTypeSelect.value : '{{ order.product_type }}';

        const templateSection = document.getElementById('templateEditSection');
        const customSection = document.getElementById('customEditSection');
        const ringSizeGroup = document.getElementById('ringSizeGroup');

        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        if (templateSection) templateSection.style.display = 'none';
        if (customSection) customSection.style.display = 'none';
        if (ringSizeGroup) ringSizeGroup.style.display = 'none';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
        if (orderType === 'template') {
            if (templateSection) templateSection.style.display = 'block';
            
            if (productType === 'ring' && ringSizeGroup) {
                ringSizeGroup.style.display = 'block';
            }
        } else if (orderType === 'custom') {
            if (customSection) customSection.style.display = 'block';
            
            if (ringSizeGroup) {
                ringSizeGroup.style.display = 'block';
            }
        }
    }

    function updateProposedPrice() {
        const orderType = document.getElementById('id_order_type_edit')?.value;
        const material = document.getElementById('id_material')?.value;
        const productType = document.getElementById('id_product_type')?.value;

        let proposedPrice = 0;

        if (orderType === 'template') {
            const templateId = document.getElementById('id_template_image')?.value;
            const ringSize = document.getElementById('id_ring_size')?.value;

            let weight = 3;
            if (productType === 'ring' && ringSize) {
                weight = Math.max(2, ringSize * 0.4);
            } else if (productType === 'brooch') {
                weight = 8;
            } else if (productType === 'bracelet') {
                weight = 12;
            } else if (productType === 'earrings') {
                weight = 2;
            }

            proposedPrice = calculateTemplatePrice(weight, material, templateId, productType);
        } else if (orderType === 'custom') {
            const desiredWeight = parseFloat(document.getElementById('id_desired_weight')?.value) || 0;
            proposedPrice = calculateCustomPrice(desiredWeight, material, productType);
        }

        const priceField = document.getElementById('estimated_price_display');
        const formField = document.getElementById('id_estimated_price');
        
        if (priceField) {
            priceField.textContent = formatPrice(proposedPrice) || '0 ‚ÇΩ';
            priceField.dataset.value = proposedPrice;
        }
        
        if (formField) {
            formField.value = proposedPrice;
        }
    }

    toggleEditSections();
    updateProposedPrice();
});

window.applyEstimatedPrice = function(e) {
    if (e) e.preventDefault();
    
    const estimatedValue = document.getElementById('estimated_price_display')?.dataset.value;
    const finalPriceField = document.getElementById('id_final_price');
    
    if (estimatedValue !== undefined && finalPriceField) {
        const numValue = parseFloat(estimatedValue);
        if (!isNaN(numValue)) {
            finalPriceField.value = numValue;
            finalPriceField.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
}

const form = document.getElementById('managerEditForm');
if (form) {
    form.addEventListener('submit', function(e) {
        console.log('=== FORM SUBMIT ===');
        const formData = new FormData(this);
        
        for (let [key, value] of formData.entries()) {
            if (key === 'ring_size') {
                console.log('‚úÖ Ring Size –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', value);
            }
        }
        
        const allHiddenDivs = this.querySelectorAll('[style*="display: none"]');
        allHiddenDivs.forEach(div => {
            const inputs = div.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name && input.value) {
                    console.log('Field from hidden div:', input.name, '=', input.value);
                }
            });
        });
    });
}

</script>

{% endblock %}
