{% extends 'base.html' %}
{% load phone_filters %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.order_id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–ó–∞–∫–∞–∑ #{{ order.order_id }}</h2>
    <div>
        <span class="badge 
            {% if order.order_status == 'new' %}bg-primary
            {% elif order.order_status == 'confirmed' %}bg-info
            {% elif order.order_status == 'in_work' %}bg-warning
            {% elif order.order_status == 'ready' %}bg-success
            {% elif order.order_status == 'delivered' %}bg-secondary
            {% endif %}
        " style="font-size: 1rem; padding: 0.5rem 1rem;">
            {{ order.get_status_display_ru }}
        </span>
    </div>
</div>

<div class="row">
    <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">–¢–∏–ø –∏–∑–¥–µ–ª–∏—è</h6>
                        <p class="mb-0">
                            {% if order.product_type == 'ring' %}
                                üíç –ö–æ–ª—å—Ü–æ
                            {% elif order.product_type == 'brooch' %}
                                üå∏ –ë—Ä–æ—à—å
                            {% elif order.product_type == 'bracelet' %}
                                üìø –ë—Ä–∞—Å–ª–µ—Ç
                            {% elif order.product_type == 'earrings' %}
                                üíé –°–µ—Ä—å–≥–∏
                            {% else %}
                                -
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">–¢–∏–ø –∑–∞–∫–∞–∑–∞</h6>
                        <p class="mb-0">
                            {% if order.order_type == 'template' %}
                                üìã –®–∞–±–ª–æ–Ω–Ω—ã–π
                            {% elif order.order_type == 'custom' %}
                                ‚úèÔ∏è –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π
                            {% else %}
                                -
                            {% endif %}
                        </p>
                    </div>
                </div>

                <hr>

                <!-- –®–ê–ë–õ–û–ù–ù–´–ô –ó–ê–ö–ê–ó -->
                {% if order.order_type == 'template' %}
                <div class="mb-3">
                    <h6 class="text-muted mb-2">–í—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω</h6>
                    <p class="mb-0">{{ order.template_image|default:"-" }}</p>
                </div>
                
                {% if order.product_type == 'ring' and order.ring_size %}
                <div class="mb-3">
                    <h6 class="text-muted mb-2">–†–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞</h6>
                    <p class="mb-0">{{ order.ring_size }}</p>
                </div>
                {% endif %}
                {% endif %}

                <!-- –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ô –ó–ê–ö–ê–ó -->
                {% if order.order_type == 'custom' %}
                <div class="card card-body bg-light mb-3">
                    <h6 class="mb-3">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–¥–µ–ª–∏—è</h6>
                    <div class="row">
                        {% if order.ring_size %}
                        <div class="col-md-6 mb-2">
                            <strong>–†–∞–∑–º–µ—Ä:</strong> {{ order.ring_size }}
                        </div>
                        {% endif %}
                        
                        {% if order.thickness %}
                        <div class="col-md-6 mb-2">
                            <strong>–¢–æ–ª—â–∏–Ω–∞:</strong> {{ order.thickness }} –º–º
                        </div>
                        {% endif %}
                        
                        {% if order.width %}
                        <div class="col-md-6 mb-2">
                            <strong>–®–∏—Ä–∏–Ω–∞:</strong> {{ order.width }} –º–º
                        </div>
                        {% endif %}
                        
                        {% if order.stone_size %}
                        <div class="col-md-6 mb-2">
                            <strong>–†–∞–∑–º–µ—Ä –∫–∞–º–Ω—è:</strong> {{ order.stone_size }} –∫–∞—Ä–∞—Ç
                        </div>
                        {% endif %}
                        
                        {% if order.desired_weight %}
                        <div class="col-md-6 mb-2">
                            <strong>–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å:</strong> {{ order.desired_weight }} –≥
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- –û–ë–©–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´ -->
                {% if order.material %}
                <div class="mb-3">
                    <h6 class="text-muted mb-2">–ú–∞—Ç–µ—Ä–∏–∞–ª</h6>
                    <p class="mb-0">
                        {% if order.material == 'gold_585' %}
                            –ó–æ–ª–æ—Ç–æ 585
                        {% elif order.material == 'gold_750' %}
                            –ó–æ–ª–æ—Ç–æ 750
                        {% elif order.material == 'silver_925' %}
                            –°–µ—Ä–µ–±—Ä–æ 925
                        {% elif order.material == 'platinum' %}
                            –ü–ª–∞—Ç–∏–Ω–∞
                        {% else %}
                            {{ order.material }}
                        {% endif %}
                    </p>
                </div>
                {% endif %}

                {% if order.comment %}
                <div class="mb-3">
                    <h6 class="text-muted mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞</h6>
                    <div class="alert alert-info mb-0">
                        {{ order.comment }}
                    </div>
                </div>
                {% endif %}

                <hr>

                <div class="row">
                    {% if order.budget %}
                    <div class="col-md-6 mb-2">
                        <h6 class="text-muted mb-2">–ë—é–¥–∂–µ—Ç</h6>
                        <p class="mb-0 fs-5 text-success"><strong>{{ order.budget }} ‚ÇΩ</strong></p>
                    </div>
                    {% endif %}
                    
                    {% if order.required_by %}
                    <div class="col-md-6 mb-2">
                        <h6 class="text-muted mb-2">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</h6>
                        <p class="mb-0">{{ order.required_by|date:"d.m.Y H:i" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ö–ª–∏–µ–Ω—Ç –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
    <div class="col-md-4">
        <!-- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–õ–ò–ï–ù–¢–ï -->
        <div class="card shadow mb-4">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">üë§ –ö–ª–∏–µ–Ω—Ç</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>{{ order.customer.name }} {{ order.customer.surname }}</strong></p>
                <p class="mb-2">
                    <i class="bi bi-telephone"></i> 
                    {{ order.customer.phone|format_phone }}
                </p>
                <p class="mb-2">
                    <i class="bi bi-envelope"></i> 
                    {{ order.customer.email|default:"-" }}
                </p>
            </div>
        </div>

        <!-- –ú–ï–ù–ï–î–ñ–ï–†/–ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨ -->
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h6>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong><br>
                    {% if order.user %}
                        {{ order.user.get_full_name|default:order.user.username }}
                    {% else %}
                        <span class="text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                    {% endif %}
                </p>
                
                <p class="mb-2">
                    <strong>–°–æ–∑–¥–∞–Ω:</strong><br>
                    {{ order.created_at|date:"d.m.Y H:i" }}
                </p>
                
                <p class="mb-0">
                    <strong>–û–±–Ω–æ–≤–ª–µ–Ω:</strong><br>
                    {{ order.updated_at|date:"d.m.Y H:i" }}
                </p>
            </div>
        </div>

        <!-- –î–ï–ô–°–¢–í–ò–Ø -->
        <div class="card shadow">
            <div class="card-body">
                <a href="{% url 'order_list' %}" class="btn btn-secondary w-100 mb-2">
                    ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                </a>
                
                {% if user.role == 'client' and order.order_status == 'new' %}
                <a href="{% url 'order_delete' order.order_id %}" 
                   class="btn btn-danger w-100"
                   onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑
                </a>
                {% endif %}

                {% if user.role == 'manager' %}
                <a href="{% url 'order_delete' order.order_id %}" 
                   class="btn btn-danger w-100"
                   onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –§–û–†–ú–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –î–õ–Ø –ú–ï–ù–ï–î–ñ–ï–†–ê -->
{% if user.role == 'manager' %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-warning">
                <h5 class="mb-0">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞)</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="managerEditForm">
                    {% csrf_token %}
                    
                    <!-- –°—Ç–∞—Ç—É—Å –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ update_form.order_status.label_tag }}
                            {{ update_form.order_status }}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ update_form.user.label_tag }}
                            {{ update_form.user }}
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- –¢–∏–ø –∏–∑–¥–µ–ª–∏—è –∏ —Ç–∏–ø –∑–∞–∫–∞–∑–∞ -->
                    <h6 class="mb-3">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ update_form.product_type.label_tag }}
                            {{ update_form.product_type }}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ update_form.order_type.label_tag }}
                            <select name="order_type" id="id_order_type_edit" class="form-control">
                                <option value="">------</option>
                                <option value="template" {% if order.order_type == 'template' %}selected{% endif %}>–®–∞–±–ª–æ–Ω–Ω—ã–π</option>
                                <option value="custom" {% if order.order_type == 'custom' %}selected{% endif %}>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- –ë–õ–û–ö: –®–∞–±–ª–æ–Ω–Ω—ã–π –∑–∞–∫–∞–∑ -->
                    <div id="templateEditSection" style="display: none;">
                        <hr>
                        <h6 class="mb-3">üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞</h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ update_form.template_image.label_tag }}
                                {{ update_form.template_image }}
                            </div>
                            
                            <div class="col-md-6 mb-3" id="templateRingSizeEdit">
                                {{ update_form.ring_size.label_tag }}
                                {{ update_form.ring_size }}
                                <small class="form-text text-muted">–¢–æ–ª—å–∫–æ –¥–ª—è –∫–æ–ª–µ—Ü</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ update_form.material.label_tag }}
                            {{ update_form.material }}
                        </div>
                        
                        <div class="mb-3">
                            {{ update_form.comment.label_tag }}
                            {{ update_form.comment }}
                        </div>
                    </div>
                    
                    <!-- –ë–õ–û–ö: –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ -->
                    <div id="customEditSection" style="display: none;">
                        <hr>
                        <h6 class="mb-3">‚úèÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞</h6>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ update_form.ring_size.label_tag }}
                                {{ update_form.ring_size }}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ update_form.thickness.label_tag }}
                                {{ update_form.thickness }}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ update_form.width.label_tag }}
                                {{ update_form.width }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ update_form.stone_size.label_tag }}
                                {{ update_form.stone_size }}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ update_form.desired_weight.label_tag }}
                                {{ update_form.desired_weight }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ update_form.material.label_tag }}
                            {{ update_form.material }}
                        </div>
                        
                        <div class="mb-3">
                            {{ update_form.comment.label_tag }}
                            {{ update_form.comment }}
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- –ë—é–¥–∂–µ—Ç –∏ —Å—Ä–æ–∫ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã) -->
                    <h6 class="mb-3">üí∞ –§–∏–Ω–∞–Ω—Å—ã –∏ —Å—Ä–æ–∫–∏</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ update_form.budget.label_tag }}
                            {{ update_form.budget }}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            {{ update_form.required_by.label_tag }}
                            {{ update_form.required_by }}
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg w-100">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const orderTypeSelect = document.getElementById('id_order_type_edit');
    const productTypeSelect = document.getElementById('id_product_type');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    toggleEditSections();
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (orderTypeSelect) {
        orderTypeSelect.addEventListener('change', toggleEditSections);
    }
    if (productTypeSelect) {
        productTypeSelect.addEventListener('change', function() {
            const orderType = orderTypeSelect ? orderTypeSelect.value : '{{ order.order_type }}';
            const productType = this.value;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞ –¥–ª—è —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
            if (orderType === 'template' && productType === 'ring') {
                document.getElementById('templateRingSizeEdit').style.display = 'block';
            } else {
                document.getElementById('templateRingSizeEdit').style.display = 'none';
            }
        });
    }
    
    function toggleEditSections() {
        const orderType = orderTypeSelect ? orderTypeSelect.value : '{{ order.order_type }}';
        const productType = productTypeSelect ? productTypeSelect.value : '{{ order.product_type }}';
        
        const templateSection = document.getElementById('templateEditSection');
        const customSection = document.getElementById('customEditSection');
        const templateRingSize = document.getElementById('templateRingSizeEdit');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        if (templateSection) templateSection.style.display = 'none';
        if (customSection) customSection.style.display = 'none';
        if (templateRingSize) templateRingSize.style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
        if (orderType === 'template') {
            if (templateSection) templateSection.style.display = 'block';
            
            // –î–ª—è –∫–æ–ª–µ—Ü –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
            if (productType === 'ring' && templateRingSize) {
                templateRingSize.style.display = 'block';
            }
        } else if (orderType === 'custom') {
            if (customSection) customSection.style.display = 'block';
        }
    }
});
</script>
{% endif %}
{% endblock %}
