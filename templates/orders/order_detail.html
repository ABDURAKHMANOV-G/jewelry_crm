{% extends 'base.html' %}
{% load phone_filters %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.order_id }} - JEWEllUX{% endblock %}

{% block content %}
<section class="order-detail-section">
    <div class="container-detail">
        
        <!-- HEADER —Å —Å—Ç–∞—Ç—É—Å–æ–º –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
        <div class="detail-header">
            <div class="detail-title-block">
                <a href="{% url 'order_list' %}" class="btn-back">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º
                </a>
                <h1 class="detail-title">
                    <i class="bi bi-file-text"></i>
                    –ó–∞–∫–∞–∑ #{{ order.order_id }}
                </h1>
                <span class="status-badge status-{{ order.order_status }}">
                    {{ order.get_status_display_ru }}
                </span>
            </div>
            
            <div class="detail-actions">
                <a href="{% url 'document_list' order.order_id %}" class="btn-action btn-documents">
                    <i class="bi bi-file-earmark-text"></i> –î–æ–∫—É–º–µ–Ω—Ç—ã
                </a>
                
                {% if user.role == 'manager' or user.role == 'client' and order.order_status == 'new' %}
                <a href="{% url 'order_delete' order.order_id %}" 
                   class="btn-action btn-delete"
                   onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')">
                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </a>
                {% endif %}
            </div>
        </div>

        <!-- GRID: –õ–µ–≤–∞—è –∏ –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∏ -->
        <div class="detail-grid">
            
            <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
            <div class="detail-card detail-card-main">
                <h2 class="card-title">
                    <i class="bi bi-info-circle"></i>
                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ
                </h2>
                
                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">–¢–∏–ø –∏–∑–¥–µ–ª–∏—è</span>
                        <span class="info-value">
                            {% if order.product_type == 'ring' %}üíç –ö–æ–ª—å—Ü–æ
                            {% elif order.product_type == 'brooch' %}üå∏ –ë—Ä–æ—à—å
                            {% elif order.product_type == 'bracelet' %}üìø –ë—Ä–∞—Å–ª–µ—Ç
                            {% elif order.product_type == 'earrings' %}üíé –°–µ—Ä—å–≥–∏
                            {% else %}-{% endif %}
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">–¢–∏–ø –∑–∞–∫–∞–∑–∞</span>
                        <span class="info-value">
                            {% if order.order_type == 'template' %}
                                <span class="order-type template">üìã –®–∞–±–ª–æ–Ω–Ω—ã–π</span>
                            {% elif order.order_type == 'custom' %}
                                <span class="order-type custom">‚úèÔ∏è –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</span>
                            {% else %}-{% endif %}
                        </span>
                    </div>
                    
                    {% if order.material %}
                    <div class="info-item">
                        <span class="info-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</span>
                        <span class="info-value material">
                            {% if order.material == 'gold_585' %}‚öúÔ∏è –ó–æ–ª–æ—Ç–æ 585
                            {% elif order.material == 'gold_750' %}‚öúÔ∏è –ó–æ–ª–æ—Ç–æ 750
                            {% elif order.material == 'silver_925' %}üî∑ –°–µ—Ä–µ–±—Ä–æ 925
                            {% elif order.material == 'platinum' %}üíé –ü–ª–∞—Ç–∏–Ω–∞
                            {% else %}{{ order.material }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                    
                    {% if order.budget %}
                    <div class="info-item">
                        <span class="info-label">–ë—é–¥–∂–µ—Ç</span>
                        <span class="info-value budget">{{ order.budget }} ‚ÇΩ</span>
                    </div>
                    {% endif %}
                    
                    {% if order.required_by %}
                    <div class="info-item">
                        <span class="info-label">–î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</span>
                        <span class="info-value">{{ order.required_by|date:"d.m.Y H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ö–ª–∏–µ–Ω—Ç -->
            <div class="detail-card">
                <h2 class="card-title">
                    <i class="bi bi-person"></i>
                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ
                </h2>
                
                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">–ò–º—è</span>
                        <span class="info-value">{{ order.customer.name }} {{ order.customer.surname }}</span>
                    </div>
                    
                    <div class="info-item">
                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                        <span class="info-value">
                            <a href="tel:{{ order.customer.phone }}">{{ order.customer.phone|format_phone }}</a>
                        </span>
                    </div>
                    
                    {% if order.customer.email %}
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">
                            <a href="mailto:{{ order.customer.email }}">{{ order.customer.email }}</a>
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ü–ê–†–ê–ú–ï–¢–†–´ –¥–ª—è CUSTOM –∑–∞–∫–∞–∑–∞ -->
        {% if order.order_type == 'custom' %}
        <div class="detail-card detail-params">
            <h2 class="card-title">
                <i class="bi bi-sliders"></i>
                –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–¥–µ–ª–∏—è
            </h2>
            <div class="params-grid">
                {% if order.ring_size %}
                <div class="param-item">
                    <span class="param-label">–†–∞–∑–º–µ—Ä</span>
                    <span class="param-value">{{ order.ring_size }}</span>
                </div>
                {% endif %}
                
                {% if order.thickness %}
                <div class="param-item">
                    <span class="param-label">–¢–æ–ª—â–∏–Ω–∞</span>
                    <span class="param-value">{{ order.thickness }} –º–º</span>
                </div>
                {% endif %}
                
                {% if order.width %}
                <div class="param-item">
                    <span class="param-label">–®–∏—Ä–∏–Ω–∞</span>
                    <span class="param-value">{{ order.width }} –º–º</span>
                </div>
                {% endif %}
                
                {% if order.stone_size %}
                <div class="param-item">
                    <span class="param-label">–†–∞–∑–º–µ—Ä –∫–∞–º–Ω—è</span>
                    <span class="param-value">{{ order.stone_size }} –∫–∞—Ä–∞—Ç</span>
                </div>
                {% endif %}
                
                {% if order.desired_weight %}
                <div class="param-item">
                    <span class="param-label">–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å</span>
                    <span class="param-value">{{ order.desired_weight }} –≥</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- –®–ê–ë–õ–û–ù –¥–ª—è TEMPLATE –∑–∞–∫–∞–∑–∞ -->
        {% if order.order_type == 'template' %}
        <div class="detail-card">
            <h2 class="card-title">
                <i class="bi bi-bookmark"></i>
                –®–∞–±–ª–æ–Ω
            </h2>
            <div class="info-group">
                <div class="info-item">
                    <span class="info-label">–í—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω</span>
                    <span class="info-value">{{ order.template_image|default:"-" }}</span>
                </div>
                
                {% if order.product_type == 'ring' and order.ring_size %}
                <div class="info-item">
                    <span class="info-label">–†–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞</span>
                    <span class="info-value">{{ order.ring_size }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –∫–ª–∏–µ–Ω—Ç–∞ -->
        {% if order.comment %}
        <div class="detail-card detail-description">
            <h2 class="card-title">
                <i class="bi bi-chat-left-text"></i>
                –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç–∞
            </h2>
            <p class="description-text">{{ order.comment }}</p>
        </div>
        {% endif %}

        <!-- –ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨ –ò –î–ê–¢–´ -->
        <div class="detail-grid detail-meta">
            <div class="detail-card">
                <h2 class="card-title">
                    <i class="bi bi-person-workspace"></i>
                    –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                </h2>
                <div class="info-item">
                    {% if order.user %}
                        <span class="info-value">{{ order.user.get_full_name|default:order.user.username }}</span>
                    {% else %}
                        <span class="info-value muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="detail-card">
                <h2 class="card-title">
                    <i class="bi bi-clock-history"></i>
                    –î–∞—Ç—ã
                </h2>
                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">–°–æ–∑–¥–∞–Ω</span>
                        <span class="info-value">{{ order.created_at|date:"d.m.Y H:i" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">–û–±–Ω–æ–≤–ª–µ–Ω</span>
                        <span class="info-value">{{ order.updated_at|date:"d.m.Y H:i" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–û–†–ú–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –î–õ–Ø –ú–ï–ù–ï–î–ñ–ï–†–ê -->
        {% if user.role == 'manager' %}
        <div class="detail-card manager-edit-card">
            <h2 class="card-title">
                <i class="bi bi-pencil-square"></i>
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–º–µ–Ω–µ–¥–∂–µ—Ä)
            </h2>
            
            <form method="POST" id="managerEditForm" class="manager-form">
                {% csrf_token %}
                
                <!-- –°—Ç–∞—Ç—É—Å –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_order_status">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</label>
                        {{ update_form.order_status }}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_user">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                        {{ update_form.user }}
                    </div>
                </div>
                
                <div class="form-divider"></div>
                
                <!-- –¢–∏–ø –∏–∑–¥–µ–ª–∏—è –∏ —Ç–∏–ø –∑–∞–∫–∞–∑–∞ -->
                <h3 class="form-section-title">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_product_type">–¢–∏–ø –∏–∑–¥–µ–ª–∏—è</label>
                        {{ update_form.product_type }}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_order_type_edit">–¢–∏–ø –∑–∞–∫–∞–∑–∞</label>
                        <select name="order_type" id="id_order_type_edit" class="form-control">
                            <option value="">------</option>
                            <option value="template" {% if order.order_type == 'template' %}selected{% endif %}>–®–∞–±–ª–æ–Ω–Ω—ã–π</option>
                            <option value="custom" {% if order.order_type == 'custom' %}selected{% endif %}>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</option>
                        </select>
                    </div>
                </div>
                
                <!-- –®–ê–ë–õ–û–ù–ù–´–ô –ó–ê–ö–ê–ó -->
                <div id="templateEditSection" style="display: none;">
                    <div class="form-divider"></div>
                    <h3 class="form-section-title">üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_template_image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label>
                            {{ update_form.template_image }}
                        </div>
                        
                        <div class="form-group" id="templateRingSizeEdit">
                            <label for="id_ring_size">–†–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞</label>
                            {{ update_form.ring_size }}
                            <small class="form-hint">–¢–æ–ª—å–∫–æ –¥–ª—è –∫–æ–ª–µ—Ü</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_material">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        {{ update_form.material }}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        {{ update_form.comment }}
                    </div>
                </div>
                
                <!-- –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ô –ó–ê–ö–ê–ó -->
                <div id="customEditSection" style="display: none;">
                    <div class="form-divider"></div>
                    <h3 class="form-section-title">‚úèÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞</h3>
                    
                    <div class="form-row form-row-3">
                        <div class="form-group">
                            <label for="id_ring_size">–†–∞–∑–º–µ—Ä</label>
                            {{ update_form.ring_size }}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_thickness">–¢–æ–ª—â–∏–Ω–∞ (–º–º)</label>
                            {{ update_form.thickness }}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_width">–®–∏—Ä–∏–Ω–∞ (–º–º)</label>
                            {{ update_form.width }}
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="id_stone_size">–†–∞–∑–º–µ—Ä –∫–∞–º–Ω—è (–∫–∞—Ä–∞—Ç)</label>
                            {{ update_form.stone_size }}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_desired_weight">–ñ–µ–ª–∞–µ–º—ã–π –≤–µ—Å (–≥)</label>
                            {{ update_form.desired_weight }}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_material">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        {{ update_form.material }}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        {{ update_form.comment }}
                    </div>
                </div>
                
                <div class="form-divider"></div>
                
                <!-- –ë—é–¥–∂–µ—Ç –∏ —Å—Ä–æ–∫ -->
                <h3 class="form-section-title">üí∞ –§–∏–Ω–∞–Ω—Å—ã –∏ —Å—Ä–æ–∫–∏</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_budget">–ë—é–¥–∂–µ—Ç (‚ÇΩ)</label>
                        {{ update_form.budget }}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_required_by">–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</label>
                        {{ update_form.required_by }}
                    </div>
                </div>
                
                <button type="submit" class="btn-gold btn-lg-full">
                    <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </form>
        </div>
        {% endif %}

    </div>
</section>

<script>
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const orderTypeSelect = document.getElementById('id_order_type_edit');
    const productTypeSelect = document.getElementById('id_product_type');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    toggleEditSections();
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (orderTypeSelect) {
        orderTypeSelect.addEventListener('change', toggleEditSections);
    }
    if (productTypeSelect) {
        productTypeSelect.addEventListener('change', function() {
            const orderType = orderTypeSelect ? orderTypeSelect.value : '{{ order.order_type }}';
            const productType = this.value;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–ª—å—Ü–∞ –¥–ª—è —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
            if (orderType === 'template' && productType === 'ring') {
                document.getElementById('templateRingSizeEdit').style.display = 'block';
            } else {
                document.getElementById('templateRingSizeEdit').style.display = 'none';
            }
        });
    }
    
    function toggleEditSections() {
        const orderType = orderTypeSelect ? orderTypeSelect.value : '{{ order.order_type }}';
        const productType = productTypeSelect ? productTypeSelect.value : '{{ order.product_type }}';
        
        const templateSection = document.getElementById('templateEditSection');
        const customSection = document.getElementById('customEditSection');
        const templateRingSize = document.getElementById('templateRingSizeEdit');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
        if (templateSection) templateSection.style.display = 'none';
        if (customSection) customSection.style.display = 'none';
        if (templateRingSize) templateRingSize.style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
        if (orderType === 'template') {
            if (templateSection) templateSection.style.display = 'block';
            
            // –î–ª—è –∫–æ–ª–µ—Ü –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
            if (productType === 'ring' && templateRingSize) {
                templateRingSize.style.display = 'block';
            }
        } else if (orderType === 'custom') {
            if (customSection) customSection.style.display = 'block';
        }
    }
});
</script>
{% endblock %}
